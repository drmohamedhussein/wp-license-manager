# WP License Manager Plugin Summary and Issues (2025-08-23_18-50-05_UTC)

## Plugin Overview

The WP License Manager (WPLM) plugin is designed to manage and validate software license keys via a REST API. It integrates with WooCommerce for product and subscription management and offers features like:

- **Custom Post Types (CPTs):** `wplm_license`, `wplm_product`, `wplm_subscription`, and `wplm_customer` are used to store data.
- **Admin Interface:** Provides various administration pages for managing licenses, products, subscriptions, customers, and settings.
- **API Management:** Handles API requests for license activation, deactivation, and validation.
- **WooCommerce Integration:** Automatically generates licenses upon WooCommerce order completion for licensed products. It also attempts to sync WooCommerce products with WPLM products.
- **Subscription System:** Includes a built-in subscription management system with cron jobs for renewals and expiry checks.
- **Customer Management System (CRM):** Allows for customer profile creation and management, including syncing with WooCommerce customer data.
- **Activity Logging:** Logs various events related to licenses, products, and customers.
- **Import/Export:** Features to import and export plugin data (licenses, products, etc.) in CSV, JSON, and XML formats.
- **Automated Licenser:** A system to inject licensing logic into uploaded plugin/theme zip files.
- **Analytics & Reports:** Provides a dashboard for displaying license, product, customer, and activity reports.

The plugin utilizes custom capabilities for role management and includes error logging to a debug log and WordPress options. It also has an emergency deactivation mechanism.

## Reported Issues

### 1. Product Management Page: License Mismatch & Missing WooCommerce Product Link

- **Problem:** On the Product Management page, there's a mismatch between "active licenses" and "total licenses." "Total licenses" should reflect the total number of licenses created for a product, while "active licenses" should reflect the number of times licenses have been activated on client websites.
- **Problem:** The WooCommerce product link is not displayed.
- **Problem:** Synchronization between WPLM products and WooCommerce products with the same name is not working correctly, leading to no differentiation between them. The plugin should show which product is related to WooCommerce and which is not via the WooCommerce product link.
- **Fix Implemented (2025-08-23_18-50-05_UTC):**
    - Corrected the "Currently Activated Licenses" calculation in `class-admin-manager.php` to accurately reflect the total number of activations across all active licenses for a product.
    - Ensured explicit display of WooCommerce product links (or a "Not linked" message) on the WPLM product edit page for better clarity and differentiation.
    - Verified that `_wplm_wc_product_id` is consistently stored and retrieved for proper linking between WooCommerce and WPLM products.

### 2. Licenses Page: "Generate Key" Not Working

- **Problem:** When clicking "Add New License" and then "Generate Key" on the Licenses page, it shows "An error occurred while generating the license key." The generated key should automatically become the title of the license.
- **Fix Implemented (2025-08-23_18-50-05_UTC):**
    - Modified `class-admin-manager.php` to correctly pass a new post nonce (`wplm_create_license_nonce`) when generating a key for a new license, and a post-specific nonce (`wplm_generate_key_{$post_id}`) for existing licenses.
    - Updated `admin-script.js` to retrieve the appropriate nonces from the button's data attributes during the AJAX call.
    - Ensured the redirect URL for newly created licenses is correctly constructed after key generation.

### 3. Subscription Menu: CSS and Redirection Issues on "Create Subscription"

- **Problem:** Clicking "Create Subscription" in the Subscription menu does not redirect to a proper page. Instead, it shows a small, unusable popup window in the corner, indicating CSS and redirection problems.
- **Fix Implemented (2025-08-23_18-50-05_UTC):**
    - Modified `enhanced-admin.js` to remove the inline `display: block;` style from the dynamically generated modal HTML. Instead, a new CSS class `wplm-modal-show` is added to display the modal.
    - Updated the `openCreateSubscriptionModal` and `closeModal` functions in `enhanced-admin.js` to add and remove the `wplm-modal-show` class, respectively.
    - Added the `.wplm-modal.wplm-modal-show` CSS rule to `enhanced-admin.css` to define the correct display properties for the modal.
    - Increased `max-width` of `.wplm-modal-content` from `600px` to `700px` for better usability.

### 4. Customer Relationship Management (CRM) Page: "Add Customers" Not Working

- **Problem:** When clicking "Add Customers" on the CRM page, no action happens. It should create a customer profile with all details (username, first name, last name, country, mobile numbers, social media links) and sync with or without WooCommerce.
- **Fix Implemented (2025-08-23_18-50-05_UTC):**
    - Added an event listener for the `#add-customer` button in `enhanced-admin.js` to trigger the new `openCreateCustomerModal` function.
    - Implemented `openCreateCustomerModal` in `enhanced-admin.js` to dynamically create and display a modal with fields for username, first name, last name, email, country, mobile number, and social media links. The modal now also handles form submission via AJAX to a new backend function.
    - Updated `ajax_create_customer` in `class-customer-management-system.php` to properly sanitize and store the new customer details (username, country, mobile number, social media links) as post meta for the `wplm_customer` custom post type. It also includes logic to use the username or email as the post title if no name is provided.
    - Modified `save_customer_meta` in `class-customer-management-system.php` to ensure that the new customer fields are correctly saved when a customer is edited directly in the WordPress admin.
    - Updated `render_customer_details_meta_box` in `class-customer-management-system.php` to display the new customer fields (username, mobile number, country, social media links) in the customer details meta box on the backend.
    - Modified `ajax_get_customer_details` in `class-customer-management-system.php` to retrieve and send the new customer fields for display in the customer details modal.
    - Ensured that dynamically added customer modals are removed on close.

### 5. Activity Log: Empty

- **Problem:** The Activity Log page is empty, even after adding licenses, products, and customers. This indicates a problem with the logging mechanism or how the logs are displayed.
- **Fix Implemented (2025-08-23_18-50-05_UTC):**
    - Modified `WPLM_Activity_Logger::log` in `class-activity-logger.php` to also store activity entries in a global WordPress option `wplm_global_activity_log`, capped at 100 recent entries. The global log now includes `object_id` and `object_type` for context.
    - Added a new static function `WPLM_Activity_Logger::get_global_log()` to retrieve this global activity log in reverse chronological order.
    - Updated `ajax_get_activity_logs` in `class-enhanced-admin-manager.php` to fetch and display data from the global activity log, including filtering by type, date range, and search value, as well as handling pagination and displaying linked objects.

### 6. Export and Import Feature: Not Working

- **Problem:** The export and import feature redirects to an empty page and crashes the website. It should be able to generate an Excel file.
- **Fix Implemented (2025-08-23_18-50-05_UTC):**
    - Implemented missing `generate_products_csv()`, `generate_subscriptions_csv()`, `generate_customers_csv()`, `generate_settings_csv()`, and `generate_activity_logs_csv()` methods to correctly generate CSV data for export.
    - Implemented missing `get_products_data()`, `get_subscriptions_data()`, `get_settings_data()`, and `get_activity_logs_data()` methods to retrieve data for JSON/XML exports.
    - Updated `export_xml()` to include all data types (licenses, products, subscriptions, customers, settings, activity logs) and ensured proper JSON encoding for array values.
    - Implemented `import_setting()` to handle the import of WPLM plugin settings, including deserialization of complex option values.
    - Implemented `import_activity_log()` to re-log imported activity entries, ensuring they are added to the global activity log.
    - Implemented `process_import_data()` to orchestrate the import process by iterating through different data types and calling the appropriate `import_single_item` function, providing detailed success/failure reports.

### 7. Add Licenses/Bulk Licenses: Missing AJAX Search for Product Selection

- **Problem:** When adding single or bulk licenses, the product selection is a simple dropdown, making it difficult to find products in large lists. An AJAX search feature is needed.
- **Fix Implemented (2025-08-23_18-50-05_UTC):**
    - Added a new AJAX action `wplm_search_products` in `class-admin-manager.php` to handle product search queries and return results in a JSON format suitable for Select2.
    - Modified `render_license_meta_box` in `class-admin-manager.php` to replace the static product dropdown with a Select2-compatible `<select>` element, including `data-current-value` for pre-selected options.
    - Enqueued Select2 CSS and JavaScript assets in `enqueue_admin_scripts` within `class-admin-manager.php`.
    - Implemented `initSelect2ProductSearch` in `admin-script.js` to initialize Select2 on the product search field, configuring it to use the new AJAX endpoint for dynamic searching.
    - Updated the `generateLicenseKey` function in `admin-script.js` to correctly retrieve the selected product ID from the new Select2 field.

### 8. Generate Licenses from WooCommerce Orders: "Error scanning orders"

- **Problem:** On the "Generate Licenses from WooCommerce Orders" page, clicking "Scan Orders" shows "Error scanning orders."

### 9. Analytics: "No data available" in Activity Report

- **Problem:** The "Activity Report" tab in the Analytics dashboard shows "No data available."
- **Fix Implemented (2025-08-23_18-50-05_UTC):**
    - Modified `render_activity_log_table` in `class-admin-manager.php` to fetch activity data from `WPLM_Activity_Logger::get_global_log()` instead of a direct database query.
    - Updated the table headers and content rendering to display `object_type` and `object_id` from the global activity log, providing more context for each activity entry.
